/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * OutputTable.java
 *
 * Created on Mar 5, 2011, 10:02:17 PM
 */
package com.ggasoftware.indigo.chemdiff;

import com.ggasoftware.indigo.IndigoObject;
import com.ggasoftware.indigo.controls.*;
import java.awt.Component;
import java.awt.Frame;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.ArrayList;
import javax.swing.JMenuItem;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JPopupMenu;

/**
 *
 * @author achurinov
 */
public class OutputTable extends TitledBorderPanel
{
   private ArrayList<? extends RenderableObjectWithId> _molecules;
   private String _common_canonical_code;
   

   public OutputTable ()
   {
      initComponents();
   }

   public void setIdColumnCount (int count)
   {
      molecules_table.setIdColumnCount(count);
   }
   
   public int getIdColumnCount ()
   {
      return molecules_table.getIdColumnCount();
   }
   
   public void setCommonCanonicalCode (String code)
   {
      _common_canonical_code = code;
   }

   /** This method is called from within the constructor to
    * initialize the form.
    * WARNING: Do NOT modify this code. The content of this method is
    * always regenerated by the Form Editor.
    */
   @SuppressWarnings("unchecked")
   // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
   private void initComponents() {

      save_panel = new javax.swing.JPanel();
      save_button = new javax.swing.JButton();
      molecules_table = new com.ggasoftware.indigo.chemdiff.MoleculeTableWithIdPanel();

      save_button.setText("Save");
      save_button.setMaximumSize(new java.awt.Dimension(120, 26));
      save_button.setMinimumSize(new java.awt.Dimension(120, 26));
      save_button.setPreferredSize(new java.awt.Dimension(120, 26));
      save_button.addActionListener(new java.awt.event.ActionListener() {
         public void actionPerformed(java.awt.event.ActionEvent evt) {
            save_buttonActionPerformed(evt);
         }
      });
      save_panel.add(save_button);

      molecules_table.addTableCellMouseListener(new com.ggasoftware.indigo.controls.TableCellMouseListener() {
         public void cellMouseDoubleClick(com.ggasoftware.indigo.controls.TableCellMouseEvent evt) {
            molecules_tableCellMouseDoubleClick(evt);
         }
         public void cellShowPopupMenu(com.ggasoftware.indigo.controls.TableCellMouseEvent evt) {
            molecules_tableCellShowPopupMenu(evt);
         }
      });

      javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
      this.setLayout(layout);
      layout.setHorizontalGroup(
         layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
         .addComponent(save_panel, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 347, Short.MAX_VALUE)
         .addComponent(molecules_table, javax.swing.GroupLayout.DEFAULT_SIZE, 347, Short.MAX_VALUE)
      );
      layout.setVerticalGroup(
         layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
         .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
            .addComponent(molecules_table, javax.swing.GroupLayout.DEFAULT_SIZE, 383, Short.MAX_VALUE)
            .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
            .addComponent(save_panel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
      );
   }// </editor-fold>//GEN-END:initComponents

    private void save_buttonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_save_buttonActionPerformed
       // TODO: save with progress bar!
       // TODO: if no properties then add ID
       
       if (_molecules.isEmpty())
       {
          JOptionPane.showMessageDialog(this, "Set is empty");
          return;
       }
       MolSaver saver = new MolSaver(Global.indigo);
       saver.addExtension("cml");
       saver.addExtension("smi");
       saver.addExtension("sdf", "sd");
       String s = saver.saveMols(_molecules);

       ArrayList<RenderableObject> invalid = saver.getInvalidObjects();
       if (!invalid.isEmpty())
       {
          StringBuilder error_messages = new StringBuilder();
          for (RenderableObject abstract_obj : invalid)
          {
             RenderableObjectWithId obj = (RenderableObjectWithId)abstract_obj;
             error_messages.append(String.format("%s: %s\n",
                     obj.getId(0), obj.getErrorMessageToRender()));
          }

          Frame parent = (Frame)getTopLevelAncestor();
          String message = String.format("Cannot save the following molecules:\n%s", 
                  error_messages.toString());
          MessageBox.show(parent, message, "Some molecules cannot be saved", MessageBox.ICON_WARNING);
       }
}//GEN-LAST:event_save_buttonActionPerformed

    private void molecules_tableCellMouseDoubleClick (com.ggasoftware.indigo.controls.TableCellMouseEvent evt)//GEN-FIRST:event_molecules_tableCellMouseDoubleClick
    {//GEN-HEADEREND:event_molecules_tableCellMouseDoubleClick
      RenderableObjectWithId item = _molecules.get(evt.row);
      
      Frame parent = (Frame)getTopLevelAncestor();
      
      MoleculeItem single = null;
      MultipleMoleculeItem mul_item = null;
      String canonical_code;
      
      if (item instanceof MoleculeItem)
      {
         single = (MoleculeItem)item;
         canonical_code = _common_canonical_code;
      }
      else
      {
         mul_item = (MultipleMoleculeItem)item;
         if (mul_item.isSingleMolecule())
            single = mul_item.getGroup(0).get(0);
         canonical_code = mul_item.getCanonicalCode();
      }
      
      if (single != null)
      {
         IndigoObject obj = item.getRenderableObject();
         if (obj == null)
         {
            String message = String.format("Exception:\n%s", item.getErrorMessageToRender());
            MessageBox.show(parent, message, 
                    "Error during loading this molecule", MessageBox.ICON_ERROR);
            return;
         }
         // Show details window for single molecule
         SingleIndigoObjectWindow details = new SingleIndigoObjectWindow(parent, 
                 obj, item.getIndigoRenderer(), false);
         if (item.getErrorMessageToRender() != null)
            details.setInformationMessage(item.getErrorMessageToRender());
         else
            details.setInformationMessage(canonical_code);
         details.setTitle(item.getId());
         details.setVisible(true);
      }
      else
      {
         // Show window with multiple molecules
         MultipleMoleculeWindow details = new MultipleMoleculeWindow(parent, mul_item);
         details.setCommonCanonicalCode(canonical_code);
         details.setRowHeight(getRowHeight());
         details.setVisible(true);
      }
    }//GEN-LAST:event_molecules_tableCellMouseDoubleClick

    private void molecules_tableCellShowPopupMenu (com.ggasoftware.indigo.controls.TableCellMouseEvent evt)//GEN-FIRST:event_molecules_tableCellShowPopupMenu
    {//GEN-HEADEREND:event_molecules_tableCellShowPopupMenu
      final TableCellMouseEvent evt_final = evt;
      
      JPopupMenu _popup_menu = new JPopupMenu();
      JMenuItem show_mi = new JMenuItem("Open in a new window");
      show_mi.addActionListener(new ActionListener()
      {
         public void actionPerformed (ActionEvent e)
         {
            molecules_tableCellMouseDoubleClick(evt_final);
         }
      });
      _popup_menu.add(show_mi);
      
      _popup_menu.show((Component)evt.mouse_event.getSource(), evt.mouse_event.getX(), evt.mouse_event.getY());
    }//GEN-LAST:event_molecules_tableCellShowPopupMenu

   public void clear ()
   {
      molecules_table.clear();
   }

   public void setMolecules (ArrayList<? extends RenderableObjectWithId> molecules)
   {
      _molecules = molecules;
      molecules_table.setObjects(_molecules);
      
      int errors_count = 0;
      for (RenderableObjectWithId obj: molecules)
         if (obj.getErrorMessageToRender() != null)
            errors_count++;
      
      StringBuilder subtitle = new StringBuilder();
      subtitle.append(String.format(": %d molecule%s", molecules.size(),
              molecules.size() > 1 ? "s" : ""));
      if (errors_count != 0)
         subtitle.append(String.format(" (with %d not valid)", errors_count));
      setSubtitle(subtitle.toString());
   }

   public void setRowHeight (int height)
   {
      molecules_table.setRowHeight(height);
   }
   
   public int getRowHeight ()
   {
      return molecules_table.getRowHeight();
   }
   
   // Variables declaration - do not modify//GEN-BEGIN:variables
   private com.ggasoftware.indigo.chemdiff.MoleculeTableWithIdPanel molecules_table;
   private javax.swing.JButton save_button;
   private javax.swing.JPanel save_panel;
   // End of variables declaration//GEN-END:variables
}
